api_version: "0.1"
test_run: true

apps:
  - name: social_auth
    path_prefix: "/${UUID}"
    host: "http://aureole:3000"

    identity:
      collection: social_auth_identity
      email:
        enabled: true

    authN:
      - type: "google"
        path_prefix: "/oauth2/google"
        authz: social_auth_jwt
        config:
          collection: social_auth_oauth2
          storage: social_auth_one_db
          client_id: "123456"
          client_secret: "123456"
          scopes:
            - "https://www.googleapis.com/auth/userinfo.email"
            - "https://www.googleapis.com/auth/userinfo.profile"
          redirect_uri: "/login"

      - type: "vk"
        path_prefix: "/oauth2/vk"
        authz: social_auth_jwt
        config:
          collection: social_auth_oauth2
          storage: social_auth_one_db
          client_id: "123456"
          client_secret: "123456"
          scopes:
            - "email"
          redirect_uri: "/login"
          fields: [ ]

      - type: "facebook"
        path_prefix: "/oauth2/facebook"
        authz: social_auth_jwt
        config:
          collection: social_auth_oauth2
          storage: social_auth_one_db
          client_id: "123456"
          client_secret: "123456"
          scopes:
            - "email"
          redirect_uri: "/login"
          fields:
            - "email"

      - type: "apple"
        path_prefix: "/oauth2/apple"
        authz: social_auth_jwt
        config:
          collection: social_auth_oauth2
          storage: social_auth_one_db
          secret_key: social_auth_jwk_file
          public_key: social_auth_jwk_file
          client_id: "123456"
          team_id: "123456"
          key_id: "123456"
          scopes:
            - "email"
            - "name"
          redirect_uri: "/login"

    authZ:
      - type: "jwt"
        name: social_auth_jwt
        config:
          sub: true
          aud: [ "${UUID}" ]
          iat: true
          jti: "0"
          alg: "RS256"
          sign_key: social_auth_jwk_file
          verify_keys: [ social_auth_jwk_file ]
          payload: "${RES_PATH}/jwt_payload.json.tmpl"

collections:
  - type: "identity"
    name: social_auth_identity
    config:
      name: "users"
      pk: "id"
      fields_map:
        id: "id"
        username: "username"
        email: "email"
        phone: "phone"
        is_active: no
        created: no
        email_verified: "email_verified"
        phone_verified: "phone_verified"

  - type: "oauth2"
    name: social_auth_oauth2
    config:
      name: "social_logins"
      pk: id
      fields_map:
        id: "id"
        social_id: "social_id"
        email: "email"
        provider: "provider"
        user_data: "user_data"
        user_id: "user_id"

storages:
  - type: "postgresql"
    name: social_auth_one_db
    config:
      url: "${DB_CONNECTION_psql}"

crypto_keys:
  - type: "jwk"
    name: social_auth_jwk_file
    path_prefix: "/${UUID}/keys"
    config:
      path: "${RES_PATH}/keys.json"