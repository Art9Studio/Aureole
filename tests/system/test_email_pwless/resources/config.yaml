api_version: "0.1"
test_run: true

apps:
  email_pwless:
    path_prefix: "/${UUID}"
    host: "http://aureole:3000"

    identity:
      collection: email_pwless_identity
      email:
        enabled: true

    authN:
      - type: "email"
        authz: email_pwless_session
        config:
          collection: email_pwless_identity
          storage: email_pwless_one_db
          login:
            path: "/login"
            fields_map:
              email: "{$.email}"
          register:
            path: "/register"
            fields_map:
              username: "{$.username}"
              email: "{$.email}"
          magic_link:
            path: "/email-confirm"
            collection: email_pwless_magic_link
            sender: email_pwless_email
            template: email_pwless_magic_link
            token:
              exp: 3600
              hash_func: "sha256"

    authZ:
      - name: email_pwless_session
        type: "session"
        config:
          collection: email_pwless_session
          storage: email_pwless_one_db
          domain: "aureole-tests"
          path: "/"
          max_age: 3600
          secure: false
          http_only: false
          same_site: ""
          clean_interval: 60

collections:
  - type: "identity"
    name: email_pwless_identity
    config:
      name: "users"
      pk: "id"
      fields_map:
        id: "id"
        username: "username"
        email: "email"
        phone: "phone"
        is_active: no
        created: no
        email_verified: "email_verified"

  - type: "email_link"
    name: email_pwless_magic_link
    config:
      name: "email_links"
      pk: "id"
      fields_map:
        id: "id"
        email: "email"
        token: "token"
        expires: "expires"
        invalid: "invalid"

  - type: "session" # main coll
    name: email_pwless_session
    config:
      name: "sessions"
      pk: "user_id"
      fields_map:
        id: "user_id"
        session_token: "session_id"
        expiration: "expiration"

storages:
  - type: "postgresql"
    name: email_pwless_one_db
    config:
      url: "${DB_CONNECTION_psql}"

crypto_keys:
  - type: "jwk"
    name: email_pwless_jwk_file
    path_prefix: "/${UUID}/keys"
    config:
      path: "${RES_PATH}/keys.json"

senders:
  - type: "email"
    name: email_pwless_email
    config:
      host: "smtp:1025"
      username: "test.aureole@gmail.com"
      password: "123456"
      insecure_skip_verify: true
      from: "test.aureole@gmail.com"
      templates:
        email_pwless_magic_link: "${RES_PATH}/magic_link.txt"